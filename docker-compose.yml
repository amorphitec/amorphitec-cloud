version: '3'

services:
  web-proxy:
    image: jwilder/nginx-proxy
    container_name: web-proxy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/tmp/docker.sock:ro
      - proxy-certs:/etc/nginx/certs:ro
      - proxy-vhosts:/etc/nginx/vhost.d
      - proxy-html:/usr/share/nginx/html
  web-proxy-letsencrypt:
    image: jrcs/letsencrypt-nginx-proxy-companion
    container_name: web-proxy-letsencrypt
    restart: unless-stopped
    environment:
      - NGINX_PROXY_CONTAINER=web-proxy
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - proxy-certs:/etc/nginx/certs:rw
      - proxy-vhosts:/etc/nginx/vhost.d
      - proxy-html:/usr/share/nginx/html
  amorphitec-www:
    build:
      context: ./www
    container_name: amorphitec-www
    restart: unless-stopped
    ports:
      - "8000:80"
    environment:
      - VIRTUAL_HOST=amorphitec.io,www.amorphitec.io,amorphitec.com,www.amorphitec.com,mail.amorphitec.io
      - LETSENCRYPT_HOST=amorphitec.io,www.amorphitec.io,amorphitec.com,www.amorphitec.com,mail.amorphitec.io
      - LETSENCRYPT_EMAIL=admin@amorphitec.io
  amorphitec-mail:
    image: tvial/docker-mailserver:latest
    container_name: amorphitec-mail
    hostname: mail
    domainname: amorphitec.io
    restart: unless-stopped
    ports:
      - "25:25"
      - "110:110"
      - "143:143"
      - "587:587"
      - "993:993"
      - "995:995"
    volumes:
      - mail-data:/var/mail
      - mail-state:/var/mail-state
      - mail-config:/tmp/docker-mailserver
      - proxy-certs:/etc/letsencrypt/live:ro
      - ./mail/config/dovecot/10-ssl.conf:/etc/dovecot/conf.d/10-ssl.conf
    environment:
      - ENABLE_SPAMASSASSIN=1
      - ENABLE_CLAMAV=0
      - ENABLE_FAIL2BAN=1
      - ENABLE_POSTGREY=1
      - ENABLE_POP3=1
      - SSL_TYPE=letsencrypt
      - ONE_DIR=1
      - DMS_DEBUG=0
    cap_add:
      - NET_ADMIN
  amorphitec-nextcloud:
    build:
      context: ./nextcloud
    container_name: amorphitec-nextcloud
    hostname: nextcloud
    domainname: amorphitec.io
    restart: unless-stopped
    ports:
      - "8001:80"
    volumes:
      - nextcloud-main:/var/www/html
      - nextcloud-apps:/var/www/html/custom_apps
      - nextcloud-config:/var/www/html/config
      - nextcloud-data:/var/www/html/data
    environment:
      - VIRTUAL_HOST=nextcloud.amorphitec.io
      - LETSENCRYPT_HOST=nextcloud.amorphitec.io
      - LETSENCRYPT_EMAIL=admin@amorphitec.io
      - NEXTCLOUD_ADMIN_USER=
      - NEXTCLOUD_ADMIN_PASSWORD=
  amorphitec-nextcloud-db:
    image: mariadb
    container_name: amorphitec-nextcloud-db
    restart: unless-stopped
    volumes:
      - nextcloud-db:/var/lib/mysql
    environment:
      - MYSQL_ROOT_PASSWORD=
      - MYSQL_PASSWORD=
      - MYSQL_DATABASE=nextcloud
      - MYSQL_USER=nextcloud

volumes:
  proxy-certs:
    driver: local-persist
    driver_opts:
      mountpoint: /var/data/www-proxy/certs
  proxy-vhosts:
    driver: local-persist
    driver_opts:
      mountpoint: /var/data/www-proxy/vhosts
  proxy-html:
    driver: local-persist
    driver_opts:
      mountpoint: /var/data/www-proxy/html
  mail-data:
    driver: local-persist
    driver_opts:
      mountpoint: /var/data/mail/data
  mail-state:
    driver: local-persist
    driver_opts:
      mountpoint: /var/data/mail/state
  mail-config:
    driver: local-persist
    driver_opts:
      mountpoint: /var/data/mail/config
  nextcloud-main:
    driver: local-persist
    driver-opts:
      mountpoint: /var/data/nextcloud/html
  nextcloud-apps:
    driver: local-persist
    driver-opts:
      mountpoint: /var/data/nextcloud/custom_apps
  nextcloud-config:
    driver: local-persist
    driver-opts:
      mountpoint: /var/data/nextcloud/config
  nextcloud-data:
    driver: local-persist
    driver-opts:
      mountpoint: /var/data/nextcloud/data
  nextcloud-db:
    driver: local-persist
    driver-opts:
      mountpoint: /var/data/nextcloud/db
